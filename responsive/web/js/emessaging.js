function initMessaging(){$(".app-container .blackout-wrapper").hide(),$(".column-2-header span:nth(1)").hide(),checkDevice(),mockData_API(),category=$(".app-container .navigation-button:nth(2)"),previousCategory=category,changeCategory(),setInterval(checkUnread(),5e3)}function changeCategory(){var e=category.data("thetitle"),t=function(){prep2C(),$(".column-2c").hide(),"contacts"!=e.toLowerCase()&&"stamps"!=e.toLowerCase()?(callCategory_API(e),closeReply(),"sent"==e.toLowerCase()?$(".message-card-header .header-line-1 span:first").text("To"):$(".message-card-header .header-line-1 span:first").text("From"),$(".column-2a ul").empty(),$.each(messageList,function(e,t){appendMessage(e,t)}),openFirst(),$(".app-container .column-2-header span:first").text(e)):"contacts"==e.toLowerCase()?contactsPopulate():"stamps"==e.toLowerCase()&&purchaseStamps(),$(".navigation-button").removeClass("navigation-button-selected"),category.addClass("navigation-button-selected")},a={alertType:"danger",content:"Warning: Your reply message will be discarded!",primaryActionText:"discard",secondaryActionText:"cancel",primaryAction:t,secondaryAction:function(){category=previousCategory}};replying?callModal(a):t(),checkUnread(),$(".column-2-header > p span:first").text("Stamps"),$(".column-2-header > p span:last").text(queryStamps_API())}function contactsPopulate(){var e,t,a=$(".contact-list-card");e=queryContacts_API(),prep2C(),a.show(),$(".contact-list-actions").show(),$(".contact-list-actions button").prop("disabled","true"),$(".column-2-header span:first").text("Contacts"),a.empty(),$.isEmptyObject(e)?(a.hide(),$(".blank-canvas").show(),$(".blank-canvas").text("You currently have no contacts saved. Please add a contact to send a message.")):(a.show(),$(".blank-canvas").hide(),$(".blank-canvas").text(""),a.append("<tr><th></th><th>Contact</th><th>Facility</th></tr>")),"desktop"==deviceType?$.each(e,function(e,t){a.append('<tr data-theContactID="'+e+'"><td><input type="radio" name="contact"></td><td>'+t.contact+"</td><td>"+t.facility+"</td></tr>")}):"mobile"==deviceType&&$.each(e,function(e,t){a.append('<tr data-theContactID="'+e+'"><td><input type="radio" name="contact"></td><td>'+t.contact+"<br><i>"+t.facility+"</i></td><td></td></tr>")}),$(".contact-list-actions").on("click touch","button",function(e){e.stopImmediatePropagation(),initReply(t=$(".contact-list-card tr input:checked").parent().parent().data("thecontactid"))}),$(".contact-list-actions").one("click touch","p",function(){contactSearch()})}function contactSearch(){var e;prep2C(),$(".contact-search-card input").val(""),$(".contact-search-card").show(),$(".search-contact-actions").show(),$(".search-contact-actions button").prop("disabled",""),$(".column-2-header span:first").text("Add Contact"),$(".search-contact-actions").one("click touch","p",function(){contactsPopulate()}),$(".search-contact-actions").one("click touch","button",function(){showContactSearch(e={facilityState:$('.contact-search-card input[name="facilityState"]').val(""),facilityName:$('.contact-search-card input[name="facilityName"]').val(""),firstName:$('.contact-search-card input[name="firstName"]').val(""),lastName:$('.contact-search-card input[name="lastName"]').val(""),inmateID:$('.contact-search-card input[name="inmateID"]').val("")})})}function showContactSearch(e){var t,a,n=$(".contact-search-results-card");t=searchInmates_API(e),prep2C(),n.show(),$(".add-contact-actions").show(),n.empty(),$.isEmptyObject(t)?(n.hide(),$(".blank-canvas").show(),$(".blank-canvas").text("Your search criteria returned no contacts.")):(n.show(),$(".blank-canvas").hide(),$(".blank-canvas").text(""),n.append("<tr><th></th><th>Inmate</th><th>Facility</th></tr>")),"desktop"==deviceType?$.each(t,function(e,t){n.append('<tr data-thecontactID="'+e+'"><td><input type="radio" name="contact"></td><td>'+t.contact+"</td><td>"+t.facility+"</td></tr>")}):"mobile"==deviceType&&$.each(t,function(e,t){n.append('<tr data-thecontactID="'+e+'"><td><input type="radio" name="contact"></td><td>'+t.contact+"<br><i>"+t.facility+"</i></td><td></td></tr>")}),$(".add-contact-actions").one("click touch","p",function(){contactSearch()}),$(".add-contact-actions").one("click touch","button",function(){a=$(".contact-search-results-card tr input:checked").parent().parent().data("thecontactid"),addContact_API(a),contactsPopulate()})}function appendMessage(e,t){var a=""!=t.attachment?"icons8-attach":"",n=1==t.unread?" unread-message":"";$(".column-2a ul").append('<li class="message-thumbnail'+n+'" data-thekey="'+e+'"><div><i class="icons8-delete-2"></i></div><div><div><input type="checkbox"><span class="email-receipt-time">'+t.time+"</span><p><span>"+t.person+'</span>&nbsp;<i class="'+a+'"></i></p><p><span>'+t.subject+"</span>&nbsp;-&nbsp;<span>"+t.body+"</span></p></div></div></li>")}function openMessage(){var e=selectedMessage.data("thekey");if("mobile"==deviceType&&($(".column-2a").hide(),$(".column-2b").show()),$(".message-card").show(),$(".message-thumbnail-selected").removeClass("message-thumbnail-selected"),selectedMessage.removeClass("unread-message"),messageList[e].unread=0,selectedMessage.addClass("message-thumbnail-selected"),$(".message-card-header .header-line-1 span:last").text(messageList[e].person),$(".message-card-header .header-line-2 span:last").text(messageList[e].subject),""!=messageList[e].attachment?($(".message-card-header .header-line-3 span:last").text(messageList[e].attachment),$(".message-card-header .header-line-3").show()):$(".header-line-3").hide(),"trash"==category.data("thetitle").toLowerCase()?($(".action-1").hide(),$(".action-2").show()):($(".action-1").show(),$(".action-2").hide()),$(".message-body").html(messageList[e].body),Object.keys(messageList[e].threadedMessages).length)for(i=Object.keys(messageList[e].threadedMessages).length-1;i>=0;i--)$(".message-body").html($(".message-body").html()+'<br><br><br><div class="threaded-message-break"></div><br><i><b>'+messageList[e].threadedMessages[i].time+", "+messageList[e].threadedMessages[i].date+"</b></i>"),""!=messageList[e].threadedMessages[i].attachment&&$(".message-body").html($(".message-body").html()+'<br><i><b>Attachment:&nbsp;<span class="inline-attachment image-link">'+messageList[e].threadedMessages[i].attachment+"</span></b></i>"),$(".message-body").html($(".message-body").html()+"<br><i>"+messageList[e].threadedMessages[i].body+"</i>");checkUnread()}function openFirst(){selectedMessage=$(".message-thumbnail:first"),"desktop"==deviceType?($(".column-2b").show(),selectedMessage.length?openMessage():(checkUnread(),clearBody())):"mobile"==deviceType&&($(".column-2b").hide(),$(".column-2c").removeClass("column-active"),$(".column-2a").show())}function moveMessage(e,t){var a=function(){void 0===t?(moveMessage_API(selectedMessage.data("thekey"),category.data("thetitle"),"restore"==e.toLowerCase()?"inbox":""),selectedMessage.remove()):"bulk"==t&&$(".message-thumbnail input:checked").each(function(){moveMessage_API($(this).parent().parent().data("thekey"),category.data("thetitle"),"restore"==e.toLowerCase()?"inbox":""),$(this).parent().parent().remove()}),clearBody(),openFirst()},n={alertType:"danger",content:"Warning: This will permanently delete the selected message(s)!",primaryActionText:"delete",secondaryActionText:"cancel",primaryAction:a,secondaryAction:""};"delete"!=e||"trash"!=category.data("thetitle").toLowerCase()&&"sent"!=category.data("thetitle").toLowerCase()?a():callModal(n)}function clearBody(){$(".message-card").hide(),$(".message-card-header .header-line-1 span:last").text(""),$(".message-card-header .header-line-2 span:last").text(""),$(".message-card-header .header-line-3 span:last").text(""),$(".message-body").text(""),selectedMessage=""}function checkUnread(){var e;(e=(e=returnUnread_API())>99?99:e)>0?($(".navigation-button .unread-email-count").text(e),$(".navigation-button:nth(2)").css("font-weight","bold")):($(".navigation-button .unread-email-count").text(""),$(".navigation-button:nth(2)").css("font-weight","normal"))}function initReply(e){var t,a,n;prep2C(),replying=!0,$(".column-2c .email-reply").show(),$(".message-reply-actions").show(),$("#attachment-form").val(""),$(".reply-info .line-3 span:nth(1)").text(""),$(".attachment-remove-button").hide(),$(".message-reply-actions input").prop("checked",!1),$(".column-2-header p span:first").text("Using"),$(".column-2-header p span:last").text("0 of "+queryStamps_API()+" Stamp(s)"),$(".navigation-button").removeClass("navigation-button-selected"),$(".column-2-header span:first").text("Compose"),$(".reply-body > div:first").text(""),void 0!==e?(a=returnContact_API(e),$(".reply-info .line-1 span:last").text(a.contact),$(".reply-info .line-2 span:last").text(""),$(".reply-info .line-2 span:last").prop("contenteditable","true"),$(".reply-info .line-2 span:last").focus()):(t=selectedMessage.data("thekey"),$(".reply-info .line-1 span:last").text(messageList[t].person),$(".reply-info .line-2 span:last").text("RE: "+messageList[t].subject),$(".reply-info .line-2 span:last").prop("contenteditable","false"),$(".reply-body > div:first").focus()),$(".app-container").on("change input",".reply-body > div, #attachment-form, .message-reply-actions input",function(){n=0,n+=$(".app-container .reply-body > div").text().length?1:0,n+=$(".app-container #attachment-form").val().length?1:0,n+=$(".app-container .message-reply-actions input").is(":checked")?1:0,$(".column-2-header p span:last").text(n+" of "+queryStamps_API()+" Stamp(s)")}),$(".app-container").on("change",".email-reply #attachment-form",function(e){e.stopImmediatePropagation();var t;$("#attachment-form").val().length?(t=(t=$(this).val().toLowerCase().replace(/\\/g,"&&&")).search("&&&")>0?t.slice(t.lastIndexOf("&&&")+3,t.length):t,$(".reply-info .line-3 span:nth(1)").text(t),$(".attachment-button").hide(),$(".attachment-remove-button").show(),$(".reply-body > div:first").focus()):($(".reply-info .line-3 span:nth(1)").text(""),$(".attachment-remove-button").hide(),$(".attachment-button").show())}),$(".app-container").on("click touch",".attachment-remove-button",function(e){e.stopImmediatePropagation(),$("#attachment-form").val("").change()}),$(".app-container").on("click touch",".message-reply-actions button",function(t){t.stopImmediatePropagation(),sendMessage(e,n)})}function closeReply(){replying=!1,$(".column-2c").removeClass("column-active"),$(".actions-panel").hide(),$(".column-2a").show(),"desktop"==deviceType?$(".column-2b").show():"mobile"==deviceType&&$(".column-2b").hide()}function sendMessage(e,t){var a;callModal({alertType:"confirmation",content:"Send the current message?",primaryActionText:"send",secondaryActionText:"return",primaryAction:function(){(a=void 0!==e?{contactID:e,subject:$(".reply-info .line-2 span:last").text()}:{messageID:selectedMessage.data("thekey")}).attachment=$(".reply-info line-3 span:last").text(),a.body=$(".reply-body div").text(),a.stampQuantity=t,sendMessage_API(a),replying=!1,changeCategory()},secondaryAction:""})}function openAttachment(e){callModal({alertType:"information",content:callImage_API(e),primaryActionText:"close",secondaryActionText:"",primaryAction:"",secondaryAction:""})}function callModal(e){var t={information:"primary-button-blue",confirmation:"primary-button-green",warning:"primary-button-orange",danger:"primary-button-red"};e.alertType=e.alertType.toLowerCase(),""!=e.content&&""!=e.alertType&&""!=e.primaryActionText&&($(".blackout-wrapper").show(),$(".modal-content-wrapper").addClass("modal-active"),e.content.indexOf("data:image")>=0?($(".modal-content-wrapper").addClass("large-modal"),$(".modal-content-wrapper .modal-message-wrapper").hide(),$(".modal-content-wrapper .modal-image").show(),$(".modal-content-wrapper .modal-image").attr("src",e.content)):($(".modal-content-wrapper").addClass("small-modal"),$(".modal-content-wrapper .modal-image").hide(),$(".modal-content-wrapper .modal-message-wrapper").show(),$(".modal-content-wrapper .modal-message-wrapper").text(e.content)),$('.modal-content-wrapper button[data-theactiontype="1"]').text(e.primaryActionText),$('.modal-content-wrapper button[data-theactiontype="1"]').addClass(t[e.alertType]),""!=e.secondaryActionText?($('.modal-content-wrapper button[data-theactiontype="2"]').show(),$('.modal-content-wrapper button[data-theactiontype="2"]').text(e.secondaryActionText)):$('.modal-content-wrapper button[data-theactiontype="2"]').hide(),$(".app-container").one("click touch",".modal-content-wrapper button",function(){1==$(this).data("theactiontype")?(closeModal(),""!=e.primaryAction&&e.primaryAction()):2==$(this).data("theactiontype")&&(closeModal(),""!=e.secondaryAction&&e.secondaryAction()),$('.modal-content-wrapper button[data-theactiontype="1"]').removeClass(t[e.alertType]),$('.modal-content-wrapper button[data-theactiontype="1"]').text(""),$('.modal-content-wrapper button[data-theactiontype="2"]').text(""),$(".modal-content-wrapper").removeClass("small-modal"),$(".modal-content-wrapper").removeClass("large-modal")}))}function closeModal(){$(".modal-content-wrapper").removeClass("modal-active"),$(".blackout-wrapper").hide()}function scrollBody(){var e,t,a,n,o,c=$(".reply-body > div").css("font-size").replace("px","");setTimeout(function(){(e=window.getSelection()).getRangeAt&&e.rangeCount&&(t=e.getRangeAt(0),(a=document.createElement("div")).innerHTML="<span></span>",n=document.createDocumentFragment(),o=a.firstChild,n.appendChild(o),t.insertNode(n)),$(".reply-body > div > span").offset().top>=$(".actions-panel").offset().top-3*c&&$(".column-2c").scrollTop($(".column-2c").scrollTop()+3*c),$(".reply-body span").remove(),scrolled=!1},50),scrolled=!0}function checkDevice(){var e;void 0===deviceType&&$(window).width()<=mobileBreakpoint?deviceType="mobile":void 0===deviceType&&(deviceType="desktop"),e=deviceType,resizeTimerActive||(resizeTimerActive=!0,e!=(deviceType=$(window).width()<=mobileBreakpoint?"mobile":"desktop")&&deviceConfig(),setTimeout(function(){resizeTimerActive=!1},50))}function deviceConfig(){var e=category.data("thetitle").toLowerCase();"mobile"==deviceType?$(".bulk-action-1").hide():"desktop"==deviceType&&("inbox"!=e&&"sent"!=e&&"drafts"!=e&&"trash"!=e||$(".column-2c").is(":visible")||($(".column-2a").show(),$(".column-2b").show(),$(".column-2b").css("display","inline-block"),openMessage())),$(".column-2c .contact-list-card").is(":visible")?contactsPopulate():$(".column-2c .contact-search-card").is(":visible")&&contactSearch()}function prep2C(){closeReply(),$(".column-2a").hide(),$(".column-2b").hide(),$(".column-2c").show(),$(".column-2c > *").hide(),$(".column-2c").addClass("column-active"),$(".actions-panel").show(),$(".actions-panel > *").hide(),$(".bulk-action").hide()}function bulkDelete(){var e;switch(category.data("thetitle").toLowerCase()){case"inbox":case"sent":case"drafts":case"trash":moveMessage("delete","bulk");break;case"contacts":callModal({alertType:"danger",content:"Warning: This will permanently delete the selected contact(s)!",primaryActionText:"delete",secondaryActionText:"cancel",primaryAction:function(){e=$(".contact-list-card tr input:checked").parent().parent().data("thecontactid"),removeContact_API(e),contactsPopulate()},secondaryAction:function(){$(".column-2-header span:nth(1)").show()}})}$(".column-2-header span:nth(1)").hide()}function purchaseStamps(){var e,t,a,n;a=$(".column-2c .purchase-stamps-card"),prep2C(),a.show(),a.find(".new-card-section").hide(),$(".actions-panel .purchase-stamps-actions").show(),$(".actions-panel button").prop("disabled","disabled"),a.find(".new-card").show(),a.find("form")[0].reset(),a.find(".stamps-chunk").empty(),$(".column-2-header span:first").text("Purchase Stamps"),e=queryContacts_API(),t=returnCreditCards_API(),$.isEmptyObject(e)?(a.hide(),$(".blank-canvas").show(),$(".blank-canvas").html('You currently have no contacts saved. Please <span class="add-contact-link">add a contact</span> prior to purchasing stamps. Stamp rates vary based on facility.')):(a.show(),$(".blank-canvas").hide(),$(".blank-canvas").text(""),a.find(".inmate-name-chunk select").empty(),a.find(".inmate-name-chunk select").append($("<option />").val(null).text("Select Inmate")),$.each(e,function(e,t){a.find(".inmate-name-chunk select").append($("<option />").val(e).text(t.contact+" ("+t.facility+")"))}),a.find(".saved-card-chunk select").empty(),a.find(".saved-card-chunk select").append($("<option />").val(null).text("Select Card")),$.each(t,function(e,t){a.find(".saved-card-chunk select").append($("<option />").val(e).text(t.number))}),a.find(".state-chunk select").empty(),a.find(".state-chunk select").append($("<option />").val(null).text("Select State")),$.each(stateListJSON,function(e,t){a.find(".state-chunk select").append($("<option />").val(t.abbreviation).text(t.name))})),$(".app-container").on("click touch",".add-contact-link",function(e){e.stopImmediatePropagation(),category=$(".app-container .controls-section li:nth(1)"),changeCategory(),contactSearch()}),$(".app-container").on("change",".inmate-name-chunk select",function(){var e;e=returnContact_API($(this).val()),a.find(".stamps-chunk").empty(),$.each(e.stamps,function(e,t){a.find(".stamps-chunk").append('<label><input type="radio" name="stampCount" value="'+e+'""><span>'+e+" Stamps ($"+t+")</span></label><br>")})}),$(".app-container").on("click touch",".new-card",function(e){e.stopImmediatePropagation(),a.find(".new-card").hide(),a.find(".new-card-section").show()}),$(".app-container").on("change",".saved-card-chunk select",function(e){e.stopImmediatePropagation(),""!=$(this).val()?(a.find(".new-card-section").hide(),a.find(".new-card").show(),$(".actions-panel button").prop("disabled","")):$(".actions-panel button").prop("disabled","disabled")}),$(".purchase-stamps-actions").on("click Touch","p",function(e){e.stopImmediatePropagation(),a.find("form")[0].reset(),category=previousCategory,a.find(".stamps-chunk").empty(),changeCategory()}),$(".purchase-stamps-actions").on("click touch","button",function(e){e.stopImmediatePropagation();var t={};$.each(a.find("form").serializeArray(),function(e,a){t[a.name]=a.value}),callModal(n={alertType:"confirmation",content:"Proceed with your purchase?",primaryActionText:"purchase",secondaryActionText:"cancel",primaryAction:function(){purchaseStamps_API(t),a.find("form")[0].reset(),category=$(".app-container .controls-section li:nth(2)"),a.find(".stamps-chunk").empty(),changeCategory()},secondaryAction:""})})}function stampHistory(){var e,t=$(".column-2c .stamp-transaction-card");e=returnTransactionHistory_API(),prep2C(),$(".column-2-header span:first").text("Stamp History"),$(".column-2-header p span:first").text("Stamps"),$(".column-2-header p span:last").text(queryStamps_API),t.show(),$(".stamp-history-actions").show(),t.empty(),t.append("<tr><th>Date</th><th>Type</th><th>Qty.</th></tr>"),$.each(e,function(e,a){t.append('<tr data-theTransactionID="'+e+'"><td>'+a.date+"</td><td>"+a.transactionType+"</td><td>"+a.quantity+"</td></tr>")}),$(".app-container").one("click touch",".stamp-history-actions p",function(e){e.stopImmediatePropagation(),changeCategory()})}var category,previousCategory,selectedMessage,unreadCount=0,replying=!1,scrolled=!1,resizeTimerActive=!1,deviceType,mobileBreakpoint=1024,tapHold=!1;$(document).ready(function(){initMessaging(),$(".app-container").on("click touch",".navigation-button",function(){previousCategory=category,category=$(this),changeCategory()}),$(".app-container").on("click touch",".logo-section button",function(){previousCategory=category,category=$(".navigation-button:first"),changeCategory()}),$(".app-container").on("click touch",".message-thumbnail",function(){selectedMessage=$(this),openMessage()}),$(".app-container").on("click touch",".image-link",function(){openAttachment($(this).text())}),$(".app-container").on("click touch",".header-actions .action-1",function(){initReply()}),$(".app-container").on("click touch",".column-2-header p",function(){stampHistory()}),$(".app-container").on("click touch",".header-actions .action-2",function(){moveMessage("restore")}),$(".app-container").on("click touch",".header-actions .action-3",function(){moveMessage("delete")}),$(".app-container").on("click touch",".bulk-action-1",function(){bulkDelete()}),$(".app-container .column-2a ul").on("swiperight","li",function(){$(".swipe-delete").removeClass("swipe-delete"),$(this).addClass("swipe-delete"),$(".swipe-delete").one("swipeleft",function(){$(this).removeClass("swipe-delete")}),$(".app-container .column-2a ul li").on("click touch","div:first",function(e){e.stopImmediatePropagation(),selectedMessage=$(".swipe-delete"),moveMessage("delete")})}),$(".app-container").on("input",".reply-body",function(){scrolled||scrollBody()}),$(".app-container").on("click touch",".message-thumbnail input",function(e){e.stopImmediatePropagation(),$(".message-thumbnail input:checked").length?$(".column-2-header span:nth(1)").show():$(".column-2-header span:nth(1)").hide()}),$(".app-container").on("click touch",".contact-list-card tr, .contacts-search-results-card tr",function(){$(this).find("input[type=radio]").prop("checked",!0),$(this).find("input[type=checkbox]").prop("checked",!$(this).find("input[type=checkbox]").prop("checked")),$(".actions-panel button").prop("disabled",!1),"desktop"==deviceType&&$(".contact-list-card").is(":visible")&&$(".bulk-action-1").show(),"mobile"==deviceType&&($(".selected-table-element").removeClass("selected-table-element"),$(this).addClass("selected-table-element"))}),$(window).resize(function(){checkDevice()})});